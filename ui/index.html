<!-- This example demonstrates how to set values via attributes and properties (recommended) -->
<!-- !!Please note that upon loading/saving this sandbox - the property values applied will not be applied without a RESTART!! -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="./src/styles.css"/>
    <title>PolicyAlign DEMO</title>
</head>
<script
        type="module"
        src="https://unpkg.com/deep-chat@2.2.2/dist/deepChat.bundle.js"
></script>
<body>
<h1>PolicyAlign DEMO</h1>
<!-- Attributes can be set as strings either directly on the element (demo/textInput) or via a `setAttribute` method on its reference (introMessage).
  When passing JSON objects make sure that they are first correctly stringified (use the following tool https://jsonlint.com/), functions assigned
  to properties must not have external references and all regex values are properly escaped.
  You can also pass values into the component via properties by using the element reference (history).
  -->
<deep-chat
        id="chat-element"
        demo="false"
        textInput='{"placeholder":{"text": "Welcome to the demo!"}}'
        style="border-radius: 10px; width: 96vw; height: calc(100vh - 120px); padding-top: 10px; font-size: 1.2rem;"
></deep-chat>
</body>
<!-- !!Either set the script as "module" or place your code in a timeout in order to wait for the component to load -->
<script type="module">
    const elementRef = document.getElementById("chat-element");

    // Persistent chat state
    let chatHistory = [];
    let threadId = `thread-${Date.now()}`;

    // Setting value via a property (easiest way)
    elementRef.history = [];
    elementRef.setAttribute(
        "introMessage",
        JSON.stringify({
            text: "Hello, how can I help you?",
        })
    );

    // AG-UI protocol connect handler with event handling
    elementRef.connect = {
        handler: async (body, signals) => {
            try {
                // Map DeepChat roles to AG-UI roles and ensure correct structure
                const aguiMessages = (body.messages || []).map((m, index) => {
                    return {
                        id: `msg-${Date.now()}-${index}`, // Unique message ID
                        role: m.role === 'ai' ? 'assistant' : m.role,
                        content: m.text || m.content || ''
                    };
                });

                // Update chat history with new messages
                for (const msg of aguiMessages) {
                    const existingIndex = chatHistory.findIndex(h => h.id === msg.id);
                    if (existingIndex === -1) {
                        chatHistory.push(msg);
                    }
                }

                // Print the complete chat history being sent
                console.log('Sending complete chat history:', chatHistory);

                if (!aguiMessages.length || !aguiMessages.some(m => m.role === 'user')) {
                    signals.onResponse({text: '[No user message to send]'});
                    return;
                }

                // Build complete AG-UI request body with full chat history
                const requestBody = {
                    threadId: threadId, // Use persistent thread ID
                    runId: `run-${Date.now()}`,
                    state: {
                        conversationLength: chatHistory.length,
                        lastMessageId: chatHistory[chatHistory.length - 1]?.id
                    },
                    tools: [],
                    context: [],
                    forwardedProps: {},
                    messages: chatHistory // Send complete history, not just current messages
                };

                const response = await fetch('http://localhost:9000/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    signals.onResponse({text: `[Backend error ${response.status}]: ${errorText}`});
                    return;
                }

                const text = await response.text();

                // Handle streaming response (Server-Sent Events)
                if (text.startsWith('data:') || text.includes('\ndata:')) {
                    const lines = text.split('\n');
                    let messageContent = '';
                    let assistantMessageId = null;

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr && jsonStr !== '[DONE]') {
                                    const data = JSON.parse(jsonStr);

                                    // Handle pydantic-ai AG-UI specific message format
                                    if (data.type === 'TEXT_MESSAGE_START' && data.messageId) {
                                        assistantMessageId = data.messageId;
                                    } else if (data.type === 'TEXT_MESSAGE_CONTENT' && data.delta) {
                                        messageContent += data.delta;
                                    }
                                }
                            } catch (e) {
                                // Silently continue on parse errors
                            }
                        }
                    }

                    if (messageContent) {
                        // Add assistant's response to chat history
                        const assistantMessage = {
                            id: assistantMessageId || `assistant-${Date.now()}`,
                            role: 'assistant',
                            content: messageContent
                        };
                        chatHistory.push(assistantMessage);

                        signals.onResponse({text: messageContent});
                    } else {
                        signals.onResponse({text: '[No content found in streaming response]'});
                    }
                    return;
                }

                // Try to parse as regular JSON
                try {
                    const data = JSON.parse(text);

                    // AG-UI event handling
                    if (Array.isArray(data)) {
                        for (const event of data) {
                            if (event.event === 'error') {
                                signals.onResponse({text: `[Error] ${event.data?.message || 'Unknown error'}`});
                                return;
                            } else if (event.event === 'system') {
                                signals.onResponse({text: `[System] ${event.data?.content || ''}`});
                                return;
                            } else if (event.event === 'message') {
                                signals.onResponse({text: event.data?.content || ''});
                                return;
                            }
                        }
                        signals.onResponse({text: '[No message event in response]'});
                    } else if (data.event) {
                        if (data.event === 'error') {
                            signals.onResponse({text: `[Error] ${data.data?.message || 'Unknown error'}`});
                        } else if (data.event === 'system') {
                            signals.onResponse({text: `[System] ${data.data?.content || ''}`});
                        } else if (data.event === 'message') {
                            signals.onResponse({text: data.data?.content || ''});
                        } else {
                            signals.onResponse({text: `[Unknown event: ${data.event}]`});
                        }
                    } else if (data.choices) {
                        signals.onResponse({text: data.choices?.[0]?.message?.content || ''});
                    } else {
                        signals.onResponse({text: '[Unrecognized response format]'});
                    }
                } catch (e) {
                    signals.onResponse({text: `[JSON parse error] ${e.message}`});
                }
            } catch (e) {
                signals.onResponse({text: `[Handler error] ${e.message}`});
            }
        }
    };
</script>
</html>
