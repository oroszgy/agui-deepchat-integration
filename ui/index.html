<!-- This example demonstrates how to set values via attributes and properties (recommended) -->
<!-- !!Please note that upon loading/saving this sandbox - the property values applied will not be applied without a RESTART!! -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="./src/styles.css"/>
    <title>PolicyAlign DEMO</title>
</head>
<script
        type="module"
        src="https://unpkg.com/deep-chat@2.2.2/dist/deepChat.bundle.js"
></script>
<body>
<h1>PolicyAlign DEMO</h1>
<!-- Attributes can be set as strings either directly on the element (demo/textInput) or via a `setAttribute` method on its reference (introMessage).
  When passing JSON objects make sure that they are first correctly stringified (use the following tool https://jsonlint.com/), functions assigned
  to properties must not have external references and all regex values are properly escaped.
  You can also pass values into the component via properties by using the element reference (history).
  -->
<deep-chat
        id="chat-element"
        demo="false"
        textInput='{"placeholder":{"text": "Welcome to the demo!"}}'
        style="border-radius: 10px; width: 96vw; height: calc(100vh - 120px); padding-top: 10px; font-size: 1.2rem;"
></deep-chat>
</body>
<!-- !!Either set the script as "module" or place your code in a timeout in order to wait for the component to load -->
<script type="module">
    const elementRef = document.getElementById("chat-element");
    // Setting value via a property (easiest way)
    elementRef.history = [];
    elementRef.setAttribute(
        "introMessage",
        JSON.stringify({
            text: "Hello, how can I help you?",
        })
    );

    // AG-UI protocol connect handler with event handling
    elementRef.connect = {
        handler: async (body, signals) => {
            try {
                // Map DeepChat roles to AG-UI roles and ensure correct structure
                // Only include 'role' and 'content' in each message, and add user.id for user messages
                const aguiMessages = (body.messages || []).map((m, index) => {
                    return {
                        id: `msg-${Date.now()}-${index}`, // Unique message ID
                        role: m.role === 'ai' ? 'assistant' : m.role,
                        content: m.text || m.content || ''
                    };
                });
                console.log('aguiMessages:', JSON.stringify(aguiMessages, null, 2));
                if (!aguiMessages.length || !aguiMessages.some(m => m.role === 'user')) {
                    signals.onResponse({text: '[No user message to send]'});
                    return;
                }
                // Build complete AG-UI request body according to protocol
                const requestBody = {
                    threadId: 'thread-1',
                    runId: `run-${Date.now()}`,
                    state: {},
                    tools: [],
                    context: [],
                    forwardedProps: {},
                    messages: aguiMessages
                };
                console.log('Full request:', JSON.stringify(requestBody, null, 2));
                const response = await fetch('http://localhost:9000/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Backend error:', errorText);
                    signals.onResponse({text: `[Backend error ${response.status}]: ${errorText}`});
                    return;
                }

                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                // Get response as text first to see the raw format
                const text = await response.text();
                console.log('Raw response:', text);

                // Try to detect if it's SSE format (starts with "data:")
                if (text.startsWith('data:') || text.includes('\ndata:')) {
                    // Parse SSE format
                    const lines = text.split('\n');
                    let messageContent = '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr && jsonStr !== '[DONE]') {
                                    const data = JSON.parse(jsonStr);
                                    console.log('Parsed SSE data:', data);

                                    // Handle pydantic-ai AG-UI specific message format
                                    if (data.type === 'TEXT_MESSAGE_CONTENT' && data.delta) {
                                        messageContent += data.delta;
                                        console.log('Added delta to messageContent:', data.delta);
                                        console.log('Current messageContent:', messageContent);
                                    } else if (data.type === 'message' || data.event === 'message') {
                                        messageContent += data.content || data.data?.content || '';
                                    } else if (data.type === 'response' && data.response) {
                                        messageContent = data.response;
                                        break;
                                    } else if (data.content) {
                                        messageContent += data.content;
                                    } else if (typeof data === 'string') {
                                        messageContent += data;
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing SSE line:', e, 'Line:', line);
                            }
                        }
                    }

                    console.log('Final messageContent before response:', messageContent);
                    if (messageContent) {
                        signals.onResponse({text: messageContent});
                    } else {
                        signals.onResponse({text: '[No content found in streaming response]'});
                    }
                    return;
                }

                // Try to parse as regular JSON
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed JSON data:', data);

                    // AG-UI event handling
                    if (Array.isArray(data)) {
                        for (const event of data) {
                            if (event.event === 'error') {
                                signals.onResponse({text: `[Error] ${event.data?.message || 'Unknown error'}`});
                                return;
                            } else if (event.event === 'system') {
                                signals.onResponse({text: `[System] ${event.data?.content || ''}`});
                                return;
                            } else if (event.event === 'message') {
                                signals.onResponse({text: event.data?.content || ''});
                                return;
                            }
                        }
                        signals.onResponse({text: '[No message event in response]'});
                    } else if (data.event) {
                        if (data.event === 'error') {
                            signals.onResponse({text: `[Error] ${data.data?.message || 'Unknown error'}`});
                        } else if (data.event === 'system') {
                            signals.onResponse({text: `[System] ${data.data?.content || ''}`});
                        } else if (data.event === 'message') {
                            signals.onResponse({text: data.data?.content || ''});
                        } else {
                            signals.onResponse({text: `[Unknown event: ${data.event}]`});
                        }
                    } else if (data.choices) {
                        signals.onResponse({text: data.choices?.[0]?.message?.content || ''});
                    } else {
                        signals.onResponse({text: '[Unrecognized response format]'});
                    }
                } catch (e) {
                    signals.onResponse({text: `[JSON parse error] ${e.message}`});
                }
            } catch (e) {
                signals.onResponse({text: `[Handler error] ${e.message}`});
            }
        }
    };
</script>
</html>
